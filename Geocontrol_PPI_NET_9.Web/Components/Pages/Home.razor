@page "/"
@rendermode InteractiveServer
@attribute [StreamRendering(true)]
@attribute [OutputCache(Duration = 5)]

@using System.ComponentModel.DataAnnotations
@using Geocontrol_PPI_NET_9.Models.Auth
@using Geocontrol_PPI_NET_9.Web.Services.Auth

@inject UserApiService LoginService
@inject NavigationManager Navigation

<PageTitle>Inicio de sesión</PageTitle>

<div class="flex items-center justify-center min-h-screen bg-gray-100">
    <div class="bg-white shadow-lg rounded-2xl p-8 w-full max-w-md">
        <h2 class="text-2xl font-semibold text-center mb-6">🔐 Iniciar sesión</h2>

        <EditForm Model="@authModel" OnValidSubmit="@HandleLogin">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Cédula</label>
                <InputText @bind-Value="authModel.Identification" class="w-full border rounded p-2" />
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                <InputText @bind-Value="authModel.Password" Type="password" class="w-full border rounded p-2" />
            </div>

            <button type="submit"
                    class="w-full bg-blue-600 text-white font-semibold py-2 rounded hover:bg-blue-700 transition">
                Ingresar
            </button>
        </EditForm>

        @if (!string.IsNullOrEmpty(Message))
        {
            <p class="text-center mt-4 font-medium @(IsError ? "text-red-600" : "text-green-600")">@Message</p>
        }
    </div>
</div>

@code {
    private Authentication authModel = new();
    private string Message = string.Empty;
    private bool IsError = false;

    private async Task HandleLogin()
    {
        try
        {
            Message = "Verificando...";
            IsError = false;

            AuthResult result = await LoginService.Autentication(authModel);

            if (result.Result)
            {
                Message = "✅ Inicio de sesión exitoso.";
                // Aquí podrías redirigir a otra página:
                Navigation.NavigateTo("/principal");
            }
            else
            {
                IsError = true;
                Message = "❌ Usuario o contraseña incorrectos.";
            }
        }
        catch (Exception ex)
        {
            IsError = true;
            Message = $"Error al autenticar: {ex.Message}";
        }
    }
}
